<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Paul Schrimpf">
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Fun with text -  </title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/atelier-forest-light.min.css">
        <link href="../assets/Documenter.css" rel="stylesheet">
        <link href="../assets/extra.css" rel="stylesheet">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href=".."> </a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">Package Docs</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">ML in Economics <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../ml-intro/" class="dropdown-item">Introduction</a>
</li>
                                    
<li>
    <a href="../ml-methods/" class="dropdown-item">Methods</a>
</li>
                                    
<li>
    <a href="../ml-doubledebiased/" class="dropdown-item">Inference</a>
</li>
                                    
<li>
    <a href="../mlExamplePKH/" class="dropdown-item">Detecting heterogeneity</a>
</li>
                                    
<li>
    <a href="../ml-julia/" class="dropdown-item">With Julia</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Neural Networks <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../slp/" class="dropdown-item">Introduction</a>
</li>
                                    
<li>
    <a href="../mlp/" class="dropdown-item">Multi-Layer</a>
</li>
                                    
<li>
    <a href="../conv/" class="dropdown-item">Convolutional</a>
</li>
                                    
<li>
    <a href="../rnn/" class="dropdown-item">Recurrent</a>
</li>
                                    
<li>
    <a href="../transformers/" class="dropdown-item">Transformers</a>
</li>
                                    
<li>
    <a href="../nn-semiparametric/" class="dropdown-item">In semiparametric models</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">About <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../license/" class="dropdown-item">License</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a href="https://github.com/schrimpf/NeuralNetworkEconomics.jl/edit/master/docs/fun_with_text.md" class="nav-link"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            
            <li class="nav-item" data-level="1"><a href="#references" class="nav-link">References</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<p><a href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a></p>
<p>This work is licensed under a <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike
4.0 International
License</a></p>
<h3 id="about-this-document">About this document<a class="headerlink" href="#about-this-document" title="Permanent link">&para;</a></h3>
<p>This document was created using Weave.jl. The code is available in <a href="https://github.com/schrimpf/NeuralNetworkEconomics.jl">on
github</a>. The same
document generates both static webpages and associated <a href="../rnn.ipynb">jupyter
notebook</a>.</p>
<p>
<script type="math/tex; mode=display">
\def\indep{\perp\!\!\!\perp}
\def\Er{\mathrm{E}}
\def\R{\mathbb{R}}
\def\En{{\mathbb{E}_n}}
\def\Pr{\mathrm{P}}
\newcommand{\norm}[1]{\left\Vert {#1} \right\Vert}
\newcommand{\abs}[1]{\left\vert {#1} \right\vert}
\DeclareMathOperator*{\argmax}{arg\,max}
\DeclareMathOperator*{\argmin}{arg\,min}
</script>
</p>
<pre><code class="language-julia">using ProgressMeter, JLD2
import HTTP, Gumbo, Cascadia
infile = joinpath(docdir,&quot;jmd&quot;,&quot;dylanchords.txt&quot;)

if !isfile(infile)
  @error &quot;$infile not found. See rnn.jmd for code to create it.&quot;  
end
text = String(read(infile));

songs = split(text, &quot;&lt;/html&gt;&quot;);
songs = songs[1:(end-1)]; # last one is empty
lyrics=Array{String,1}(undef,length(songs));
titles=Array{String,1}(undef,length(songs));

# function to extract text from HTMLNodes
gettext(h::Gumbo.HTMLText) = Gumbo.text(h)
gettext(h::AbstractArray) = length(h)==0 ? &quot;&quot; : prod(gettext, h)
gettext(h::Gumbo.HTMLNode) = gettext(Gumbo.children(h))
# remove chords from verses
function removechords(txt)
  chordregexp=r&quot;(^)( {0,1000}|\()(A|B|C|D|E|G|F)(\S{0,6})(\)| {2,1000}| \.|$).*&quot;m
  txt2=replace(txt, chordregexp =&gt; &quot;\n&quot;)
  replace(txt2, r&quot;( {2,1000})&quot;=&gt;&quot; &quot;)
end
for (i,song) = enumerate(songs)
  html=Gumbo.parsehtml(song);
  t = eachmatch(Cascadia.Selector(&quot;.songtitle&quot;), html.root)
  (length(t)==1) || @warn &quot;multiple songtitles for songs[$i]&quot;
  titles[i] = gettext(t)
  t = eachmatch(Cascadia.Selector(&quot;.verse,.refrain&quot;), html.root)  
  lyrics[i] = removechords(gettext(t))
end
lyrics = lyrics[length.(lyrics).&gt;0];
</code></pre>
<pre><code class="language-julia">using Flux
using Flux: onehot, chunk, batchseq, throttle, crossentropy
using StatsBase: wsample
using Base.Iterators: partition
using ProgressMeter

endchar = 'Î©' # any character not in original text
alphabet = [unique(collect(prod(lyrics)))..., endchar]
stop = onehot(endchar, alphabet);
# maxlen = 100 # we will split songs after this many characters
# #batchsize=100 # we use this many &quot;songs&quot; (after splitting) per gradient descent batch
# nextchars = ((x)-&gt;[x[2:end]..., endchar]).(lyrics);
# function makex(lyrics, maxlen)
#   hotlyrics=map.(c-&gt;onehot(c, alphabet), collect.(lyrics));
#   cs = Int.(ceil.(length.(hotlyrics)./maxlen))
#   foo=chunk.(hotlyrics, cs);
#   X=[gpu.(batchseq(f, stop)) for f in foo];
# end
# Xb = (makex(lyrics, maxlen));
# Yb = (makex(nextchars, maxlen));
# #addaf(daf)
# #  [gpu.(batchseq(map.(c-&gt;onehot(c, alphabet), nextchars[p]), stop))
# #     for p in partition(1:length(splitlyrics), batchsize)];
# #Xb = [[x[:,p] for x in X] for p in partition(1:size(X[1],2), batchsize)];
# #Yb = [[y[:,p] for y in Y] for p in partition(1:size(Y[1],2), batchsize)];
# data = collect(zip(Xb,Yb));
# println(&quot;There are $(length(data)) batches per epoch&quot;)

if true
  text = collect(prod(lyrics));
  hottext = map(ch -&gt; onehot(ch, alphabet), text);

  maxlen = 100
  batchsize = 1000

  Xseq = collect(partition(gpu.(batchseq(chunk(hottext, batchsize),stop)), maxlen));
  Yseq = collect(partition(gpu.(batchseq(chunk(hottext[2:end], batchsize),stop)), maxlen));
  data = collect(zip(Xseq, Yseq));
end

N = length(alphabet)

function sample(m, alphabet, len)
  m = cpu(m)
  Flux.reset!(m) 
  buf = IOBuffer()
  c = '\n'
  for i = 1:len
    write(buf, c)
    c = wsample(alphabet, m(onehot(c, alphabet)).data)
  end
  return String(take!(buf))
end
opt = RMSProp(0.005)
# this will take awhile, so a fancier call back with a progress meter is nice to have 
function cbgenerator(N, loss, printiter=Int(round(N/10)))
  p=Progress(N, 1, &quot;Training&quot;, 25)
  i=0  
  function cb()
    next!(p)
    if (i % printiter==0)
      @show loss()
    end
    i+=1
  end
  return(cb)
end

N = length(alphabet)
testsong = 1
function train_model!(m; N=N, data=data,
                      modelfile=&quot;tmp.jld2&quot;, 
                      opt=RMSProp(0.01), testset=testsong, epochs=20)
  function loss(xb::V, yb::V) where V &lt;:AbstractVector
    #Flux.reset!(m)
    l = sum(crossentropy.(m.(xb),yb))/length(xb)
    #l = crossentropy(m(xb),yb)
    Flux.truncate!(m)
    return(l)
  end
  #function loss(xb, yb)
  #  Flux.reset!(m) # after each song, forget gradients  
  #  l = crossentropy(m(xb),yb)
  #  return(l)
  #end

  cb=cbgenerator(length(data)*(epochs+1),
                 ()-&gt;loss(data[testset]...)) 

  if isfile(modelfile)
    @load modelfile cpum
    m = gpu(cpum)
  end

  @time Flux.train!(loss, Flux.params(m), data, opt, cb = cb)
  println(&quot;Sampling after 1 epoch:&quot;)
  sample(m, alphabet, 1000) |&gt; println

  Flux.@epochs epochs Flux.train!(loss, Flux.params(m), data, opt,
                                  cb = cb)
  cpum = cpu(m)
  @save modelfile cpum
  return(m)
end

for L in [75] #, 32, 64, 128] #, 256, 512]
  #L = 100
  file = joinpath(docdir,&quot;jmd&quot;,&quot;dylanlyrics-$L.jld2&quot;)
  m = Chain(LSTM(N, L), LSTM(L, L),  Dense(L, N),  softmax) |&gt; gpu
  #m = Chain(GRU(N, L), GRU(L, L), Dense(L, N),  softmax) |&gt; gpu
  opt=RMSProp(0.01)
  m = train_model!(m, opt=opt, epochs=100, modelfile=file)
  println(&quot;ÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎ&quot;)
  println(&quot;ÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎ&quot;)
  println(&quot;ÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎ&quot;)  
  println(&quot;Model $L has $(sum([prod(size(p)) for p in Flux.params(m)])) parameters&quot;)
  println(&quot;Sample from model $L&quot;)
  println(&quot;ÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎÎ&quot;)
  println(sample(m, alphabet, 5000))
  println()
end
</code></pre>
<pre><code>Error: UndefVarError: truncate! not defined
</code></pre>
<h1 id="references">References<a class="headerlink" href="#references" title="Permanent link">&para;</a></h1></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Paul Schrimpf</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_HTML" defer></script>
        <script src="../assets/mathjaxhelper.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
